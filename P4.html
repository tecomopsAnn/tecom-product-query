<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TECOM｜維修結果查詢</title>
<style>
:root{--bg:#f6f8fb;--primary:#0b3a67;--bd:#dbe3ef;}
*{box-sizing:border-box;font-family:system-ui,-apple-system,"Noto Sans TC",Arial;}
body{margin:0;background:var(--bg);}
.topbar{background:var(--primary);color:#fff;padding:14px 18px;font-weight:800;}
.wrap{padding:16px;max-width:1200px;margin:0 auto;}
.filter-card{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:16px;margin-bottom:16px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;}
label{font-size:12px;color:#64748b;display:block;margin-bottom:4px;}
select, input{width:100%;padding:8px;border:1px solid var(--bd);border-radius:8px;}
.btn-query{background:#2563eb;color:#fff;border:0;border-radius:8px;padding:10px;font-weight:800;cursor:pointer;margin-top:20px;}

.stat-box{display:flex;gap:16px;margin-bottom:16px;}
.stat-item{flex:1;background:#fff;padding:16px;border-radius:14px;border:1px solid var(--bd);text-align:center;}
.stat-num{font-size:24px;font-weight:800;color:var(--primary);}

.table-wrap{background:#fff;border-radius:14px;border:1px solid var(--bd);overflow:hidden;}
table{width:100%;border-collapse:collapse;font-size:14px;}
thead{background:var(--primary);color:#fff;}
th, td{padding:12px;text-align:left;border-bottom:1px solid var(--bd);}
tr:hover{background:#f8fafc;}
.img-link{color:#2563eb;text-decoration:none;font-weight:bold;}
</style>
</head>
<body>
<div class="topbar">TECOM｜維修數據統計查詢</div>
<div class="wrap">
  <div class="filter-card">
    <div class="grid">
      <div><label>地區</label><select id="f_region"><option value="">全部</option><option>北區</option><option>中區</option><option>南區</option><option>新竹</option></select></div>
      <div><label>類別</label><select id="f_category"><option value="">全部</option><option>XVR</option><option>NVR</option><option>類比攝影機</option><option>網路攝影機</option></select></div>
      <div><label>年份</label><select id="f_year"><option value="2026">2026</option><option value="2025">2025</option></select></div>
      <div><label>季度</label><select id="f_quarter"><option value="">全部</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select></div>
      <div><label>月份</label><select id="f_month"><option value="">全部</option><option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="12">12月</option></select></div>
      <div><label>料號</label><input id="f_product_code" placeholder="關鍵字"></div>
      <div><label>型號</label><input id="f_model_no" placeholder="關鍵字"></div>
    </div>
    <button class="btn-query" onclick="doSearch()">執行查詢</button>
  </div>

  <div class="stat-box" id="statArea" style="display:none;">
    <div class="stat-item"><div>總案件數</div><div class="stat-num" id="totalCount">0</div></div>
    <div class="stat-item"><div>常見故障</div><div id="topIssue" style="font-size:14px;margin-top:5px;">無</div></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>日期</th><th>維修單號</th><th>地區</th><th>工程師</th><th>料號 / 型號</th><th>問題描述</th><th>照片</th></tr>
      </thead>
      <tbody id="resultBody">
        <tr><td colspan="7" style="text-align:center;padding:40px;color:#94a3b8;">請設定條件後點擊「執行查詢」</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxFDQQjjRJFXQ1ldI62IlRv7-f5V1e82G31dcAf1-wgC2dfyvbVfEaYiecmWjpTVXdK/exec';

async function doSearch() {
  const btn = document.querySelector('.btn-query');
  btn.disabled = true;
  btn.textContent = '搜尋中...';
  
  const filters = {
    region: document.getElementById('f_region').value,
    category: document.getElementById('f_category').value,
    year: document.getElementById('f_year').value,
    quarter: document.getElementById('f_quarter').value,
    month: document.getElementById('f_month').value,
    product_code: document.getElementById('f_product_code').value,
    model_no: document.getElementById('f_model_no').value,
    action: 'queryAdv'
  };

  try {
    const r = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({action:'queryAdv', filters}) });
    const j = await r.json();
    if (j.ok) renderResult(j.rows);
  } catch (e) {
    alert('查詢失敗，請檢查網路');
  } finally {
    btn.disabled = false;
    btn.textContent = '執行查詢';
  }
}

function renderResult(rows) {
  const body = document.getElementById('resultBody');
  document.getElementById('statArea').style.display = 'flex';
  document.getElementById('totalCount').textContent = rows.length;
  
  if (rows.length === 0) {
    body.innerHTML = '<tr><td colspan="7" style="text-align:center;">查無資料</td></tr>';
    document.getElementById('topIssue').textContent = '無';
    return;
  }

  // 簡單統計問題描述
  const issues = rows.map(r => r.issue_desc).slice(0, 3).join(', ');
  document.getElementById('topIssue').textContent = issues + (rows.length > 3 ? '...' : '');

  body.innerHTML = rows.map(r => `
    <tr>
      <td>${new Date(r.receive_date).toLocaleDateString()}</td>
      <td style="font-size:12px;color:#64748b;">${r.repair_id}</td>
      <td>${r.region}</td>
      <td>${r.engineer}</td>
      <td><b>${r.product_code}</b><br><small>${r.model_no}</small></td>
      <td>${r.issue_desc}</td>
      <td>${r.media_urls ? `<a href="${r.media_urls.split('\n')[0]}" target="_blank" class="img-link">查看照片</a>` : '無'}</td>
    </tr>
  `).join('');
}
</script>
</body>
</html>

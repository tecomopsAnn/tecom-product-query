<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TECOM｜P3 維修回報</title>
<style>
:root{--bg:#f6f8fb;--card:#fff;--bd:#dbe3ef;--txt:#0f172a;--muted:#64748b;}
*{box-sizing:border-box;font-family:system-ui,-apple-system,"Noto Sans TC",Arial;}
body{margin:0;background:var(--bg);}
.topbar{background:#0b3a67;color:#fff;padding:14px 18px;font-weight:800;}
.wrap{display:flex;gap:16px;padding:16px;max-width:1100px;margin:0 auto;}
.nav{width:290px;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:12px;}
.nav a{display:block;padding:12px;border-radius:10px;color:#000;text-decoration:none;margin:6px 0;}
.nav a.active{background:#eaf2ff;font-weight:800;}
.card{flex:1;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:16px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
label{font-size:13px;color:var(--muted);}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;}
textarea{min-height:90px;}
.full{grid-column:1/-1;}
.btn{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:800;}
.status{margin-top:12px;font-size:13px;white-space:pre-line;}
@media(max-width:900px){.wrap{flex-direction:column}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="topbar">TECOM｜P3 維修回報</div>

<div class="wrap">
<nav class="nav">
<a href="./index.html">1 料號查詢</a>
<a href="./p2.html">2 序號查詢</a>
<a class="active">3 維修回報</a>
</nav>

<section class="card">
<form id="form">
<div class="grid">

<div>
<label>料號 product_code（必填）</label>
<input id="productCode" required />
</div>

<div>
<label>型號 model_no（自動帶出）</label>
<input id="modelNo" readonly />
</div>

<div>
<label>區域（必填）</label>
<select id="region" required>
<option value="">請選擇</option>
<option>北區</option><option>中區</option><option>南區</option><option>新竹</option>
</select>
</div>

<div>
<label>工程師（必填）</label>
<select id="engineer" required>
<option value="">請選擇</option>
<option>永富</option><option>賜郎</option><option>賜福</option><option>煌良</option><option>金菊</option>
</select>
</div>

<div>
<label>產品序號 serial_no</label>
<input id="productSN" required />
</div>

<div>
<label>收件日期</label>
<input id="receiveDate" type="date" required />
</div>

<div class="full">
<label>問題描述 issue_desc</label>
<textarea id="reason" required></textarea>
</div>

<div class="full">
<label>備註 note</label>
<textarea id="note"></textarea>
</div>

<div class="full">
<label>照片上傳</label>
<input id="photos" type="file" multiple accept="image/*" />
</div>

<div class="full">
<button class="btn">送出</button>
</div>

</div>
</form>

<div id="status" class="status">狀態：待送出</div>
</section>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgliyhb8A-xNzsosa-iJ0g-R4DpnX2EZy3DbSG7DC7QWs8xxPdR3c_fTPxnF4bngJ5WQ/exec';
const $ = id => document.getElementById(id);

// 預設日期
(() => {
 const d=new Date(),p=n=>String(n).padStart(2,'0');
 $('receiveDate').value=`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
})();

// 料號 → 查型號
$('productCode').addEventListener('blur', async () => {
 const code=$('productCode').value.trim();
 if(!code) return;
 const r=await fetch(WEB_APP_URL,{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({action:'lookupModel',product_code:code})
 });
 const j=await r.json();
 $('modelNo').value = j.ok ? (j.model_no || '查無資料') : '查詢失敗';
});

$('form').addEventListener('submit', async e=>{
 e.preventDefault();
 const data={
  productCode:$('productCode').value,
  modelNo:$('modelNo').value,
  productSN:$('productSN').value,
  region:$('region').value,
  engineer:$('engineer').value,
  receiveDate:$('receiveDate').value,
  reason:$('reason').value,
  note:$('note').value,
  createdBy:'P3-Web'
 };
 const files=[...$('photos').files];
 const images=[];
 for(const f of files){
  const b=await new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(f)});
  images.push({name:f.name,type:f.type,base64:b});
 }
 const r=await fetch(WEB_APP_URL,{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({action:'submit',data,images})
 });
 const j=await r.json();
 $('status').textContent = j.ok ? `完成！repair_id=${j.repair_id}` : `失敗：${j.error}`;
});
</script>
</body>
</html>

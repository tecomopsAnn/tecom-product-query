<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TECOM｜P3 維修回報</title>
<style>
:root{--bg:#f6f8fb;--card:#fff;--bd:#dbe3ef;--txt:#0f172a;--muted:#64748b;}
*{box-sizing:border-box;font-family:system-ui,-apple-system,"Noto Sans TC",Arial;}
body{margin:0;background:var(--bg);}
.topbar{background:#0b3a67;color:#fff;padding:14px 18px;font-weight:800;}
.wrap{display:flex;gap:16px;padding:16px;max-width:1100px;margin:0 auto;}
.nav{width:290px;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:12px;}
.nav a{display:block;padding:12px;border-radius:10px;color:#000;text-decoration:none;margin:6px 0;}
.nav a.active{background:#eaf2ff;font-weight:800;}
.card{flex:1;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:16px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px;}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;font-size:16px;}
textarea{min-height:90px;}
.full{grid-column:1/-1;}
.btn{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:800;width:100%;cursor:pointer;}
.btn:disabled{background:#cbd5e1;cursor:not-allowed;}
.status{margin-top:12px;font-size:14px;padding:10px;border-radius:8px;background:#f8fafc;}
@media(max-width:900px){.wrap{flex-direction:column}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="topbar">TECOM｜P3 維修回報</div>

<div class="wrap">
<nav class="nav">
<a href="./index.html">1 料號查詢</a>
<a href="./p2.html">2 序號查詢</a>
<a class="active">3 維修回報</a>
</nav>

<section class="card">
<form id="form">
<div class="grid">
<div>
<label>料號 product_code（必填，輸入完點旁邊）</label>
<input id="productCode" placeholder="例如: RP4L00339" required />
</div>

<div>
<label>型號 model_no（自動帶出）</label>
<input id="modelNo" readonly style="background:#f1f5f9" placeholder="自動查詢中..." />
</div>

<div>
<label>區域（必填）</label>
<select id="region" required>
<option value="">請選擇</option>
<option>北區</option><option>中區</option><option>南區</option><option>新竹</option>
</select>
</div>

<div>
<label>工程師（必填）</label>
<select id="engineer" required>
<option value="">請選擇</option>
<option>永富</option><option>賜郎</option><option>賜福</option><option>煌良</option><option>金菊</option>
</select>
</div>

<div>
<label>產品序號 serial_no</label>
<input id="productSN" required />
</div>

<div>
<label>收件日期</label>
<input id="receiveDate" type="date" required />
</div>

<div class="full">
<label>問題描述 issue_desc</label>
<textarea id="reason" required></textarea>
</div>

<div class="full">
<label>備註 note</label>
<textarea id="note"></textarea>
</div>

<div class="full">
<label>照片上傳 (可選多張)</label>
<input id="photos" type="file" multiple accept="image/*" />
</div>

<div class="full">
<button type="submit" id="submitBtn" class="btn">確認送出</button>
</div>
</div>
</form>

<div id="status" class="status">狀態：等待輸入資料</div>
</section>
</div>

<script>
// 請將下方的網址替換成妳「部署」後的 Web App 網址
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz6E5FLzlGDSY1VUZU8a8Xpr3KYYhvPWqYmso8tkXhs7QAH7sGMvdc5t8j7k6cdBx3S/exec';
const $ = id => document.getElementById(id);

// 1. 初始化預設日期
(() => {
  const d=new Date(), p=n=>String(n).padStart(2,'0');
  $('receiveDate').value=`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
})();

// 2. 料號輸入完畢自動查型號
$('productCode').addEventListener('blur', async () => {
  const code = $('productCode').value.trim();
  if (!code) return;
  
  $('status').textContent = '狀態：正在查詢型號庫...';
  try {
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'lookupModel', product_code: code })
    });
    const result = await resp.json();
    if (result.ok) {
      $('modelNo').value = result.model_no || '資料庫無此料號';
      $('status').textContent = result.model_no ? '狀態：型號查詢成功' : '狀態：查無資料，請檢查料號';
    }
  } catch (e) {
    $('status').textContent = '狀態：通訊失敗，請檢查網路';
  }
});

// 3. 表單送出處理
$('form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const btn = $('submitBtn');
  btn.disabled = true;
  btn.textContent = '系統處理中，請勿關閉網頁...';
  $('status').textContent = '狀態：正在準備圖片並上傳至 Google Drive...';

  try {
    // 讀取檔案轉 Base64
    const files = [...$('photos').files];
    const images = [];
    for (const f of files) {
      const base64 = await new Promise(res => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.readAsDataURL(f);
      });
      images.push({ name: f.name, type: f.type, base64: base64 });
    }

    const payload = {
      action: 'submit',
      data: {
        productCode: $('productCode').value,
        modelNo: $('modelNo').value,
        productSN: $('productSN').value,
        region: $('region').value,
        engineer: $('engineer').value,
        receiveDate: $('receiveDate').value,
        reason: $('reason').value,
        note: $('note').value
      },
      images: images
    };

    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const result = await resp.json();

    if (result.ok) {
      $('status').innerHTML = `<b style="color:green">✅ 維修回報成功！</b><br>單號：${result.repair_id}`;
      $('form').reset();
      // 重新填入日期
      const d=new Date(), p=n=>String(n).padStart(2,'0');
      $('receiveDate').value=`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
    } else {
      $('status').textContent = '❌ 送出失敗：' + result.error;
    }
  } catch (err) {
    $('status').textContent = '❌ 系統通訊出錯，請稍後再試';
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.textContent = '確認送出';
  }
});
</script>
</body>
</html>

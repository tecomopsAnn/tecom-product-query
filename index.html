<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TECOMÔΩúÂ§ñË≥ºÂìÅÁî¢ÂìÅ / ÂÇôÂìÅÊü•Ë©¢Á≥ªÁµ±ÔºàÁ∂≠‰øÆ‰∫∫Âì°Â∞àÁî®Ôºâ</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --line:#d7e2f3;
      --text:#0f172a;
      --muted:#5b6b85;

      --brand:#0b3a75;
      --brand-2:#0e4a92;
      --brand-3:#eaf2ff;
      --accent:#1b77ff;
      --danger:#c0262d;
      --ok:#0f766e;

      --radius:14px;
      --shadow: 0 10px 26px rgba(15, 23, 42, .08);
      --shadow2: 0 6px 16px rgba(15, 23, 42, .06);
      --font: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }

    .topbar{
      background:linear-gradient(90deg, var(--brand), var(--brand-2));
      color:#fff;
      padding:18px 18px;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow:0 4px 16px rgba(0,0,0,.12);
    }
    .topbar .wrap{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand-title{ font-size:18px; font-weight:900; letter-spacing:.2px; line-height:1.25; }

    .page{
      max-width:1200px;
      margin:18px auto 18px;
      padding:0 18px;
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:18px;
    }
    @media (max-width: 980px){ .page{ grid-template-columns: 1fr; } }

    .sidebar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .menu{ padding:10px 8px 8px; display:flex; flex-direction:column; gap:6px; }
    .menu button{
      border:1px solid transparent;
      background:transparent;
      text-align:left;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      color:var(--text);
      font-weight:800;
      font-size:14px;
      transition:.15s ease;
    }
    .menu button:hover{ background:#f1f6ff; border-color:var(--line); }
    .menu button.active{
      background:linear-gradient(180deg, #eaf2ff, #ffffff);
      border-color:var(--line);
      color:var(--brand);
      box-shadow:0 2px 0 rgba(11,58,117,.08) inset;
    }
    .hint{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12.5px;
      border-top:1px solid var(--line);
    }

    .main{ display:flex; flex-direction:column; gap:14px; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .bar{
      padding:14px 16px;
      background:linear-gradient(90deg, #0b3a75, #0e4a92);
      color:#fff;
      font-weight:900;
      letter-spacing:.3px;
    }
    .card .body{ padding:16px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 760px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size:12.5px; color:var(--muted); margin-bottom:6px; font-weight:800; }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:#fff;
      font-family:var(--font);
    }
    textarea{ min-height:92px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color:#9dc0ff;
      box-shadow:0 0 0 4px rgba(27,119,255,.12);
    }

    .btn{
      padding:11px 14px;
      border-radius:12px;
      border:1px solid rgba(27,119,255,.35);
      background:linear-gradient(180deg, #2b86ff, #1b77ff);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.12s ease;
      min-width:120px;
    }
    .btn:hover{ filter:brightness(1.02); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .btn2{
      padding:11px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--brand);
      font-weight:900;
      cursor:pointer;
      transition:.12s ease;
      min-width:120px;
    }
    .btn2:hover{ background:#f6f9ff; }

    .msg{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      white-space:pre-wrap;
    }
    .msg.error{ color:var(--danger); font-weight:900; }
    .msg.ok{ color:var(--ok); font-weight:900; }

    .section-title{ margin:12px 0 8px; font-weight:900; color:var(--brand); font-size:16px; }

    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 12px;
      padding:12px;
      border:1px dashed #cfe0ff;
      background:#f7fbff;
      border-radius:12px;
      margin-top:10px;
      font-size:14px;
    }
    .kv .k{ color:var(--muted); font-weight:900; }
    .kv .v{ font-weight:900; }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13.5px;
      vertical-align:top;
    }
    th{
      background:#f2f7ff;
      color:var(--brand);
      font-weight:900;
      text-align:left;
    }
    tr:last-child td{ border-bottom:none; }

    .footer-note{ margin-top:10px; font-size:12px; color:var(--muted); }
    .panel{ display:none; }
    .panel.active{ display:block; }

    .thumbs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .thumb{
      width:86px; height:86px;
      border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 16px rgba(15,23,42,.06);
      text-decoration:none;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:12px;
      color:var(--brand);
      text-decoration:none;
    }

    .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 760px){ .two-col{ grid-template-columns:1fr; } }
  </style>

  <script>
    // ‚úÖ ‰Ω†ÁöÑ WebApp exec URLÔºà‰øùÊåÅ‰∏çËÆäÔºâ
    const API_BASE = "https://script.google.com/macros/s/AKfycbwMLY5i8ZYW6YwnbiJijPqxECPoZR6ZJfHS3Ip5sjsIzECqrgcv--N0pN2_Aqt5RTQqmQ/exec";

    const MAX_PHOTOS = 5;
    const MAX_FILE_MB = 5;
    const MAX_VIDEO_SECONDS = 60;

    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const sep = url.includes("?") ? "&" : "?";
        const full = url + sep + "callback=" + cbName;

        const script = document.createElement("script");
        script.src = full;

        function cleanup(){
          try { delete window[cbName]; } catch(e){}
          script.remove();
        }

        script.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };
        window[cbName] = (data) => { cleanup(); resolve(data); };

        document.body.appendChild(script);
      });
    }

    function qs(obj){
      const p = new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>{
        if (v !== undefined && v !== null && String(v).trim() !== "") p.append(k, v);
      });
      return p.toString();
    }

    function setMsg(panelId, type, text){
      const el = document.getElementById(panelId + "_msg");
      if (!el) return;
      el.className = "msg " + (type || "");
      el.textContent = text || "";
    }

    function esc(v){
      const s = String(v == null ? "" : v);
      return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }

    function uuid(){
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = Math.random()*16|0;
        const v = c === "x" ? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    async function getVideoDurationSeconds(file){
      return new Promise((resolve)=>{
        try{
          const url = URL.createObjectURL(file);
          const v = document.createElement("video");
          v.preload = "metadata";
          v.onloadedmetadata = () => { URL.revokeObjectURL(url); resolve(v.duration || 0); };
          v.onerror = () => { URL.revokeObjectURL(url); resolve(0); };
          v.src = url;
        }catch(e){ resolve(0); }
      });
    }

    async function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> {
          const s = String(reader.result || "");
          const idx = s.indexOf("base64,");
          const b64 = idx >= 0 ? s.slice(idx + 7) : s;
          resolve(b64);
        };
        reader.onerror = ()=> reject(new Error("FileReader error"));
        reader.readAsDataURL(file);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const menu = document.getElementById("menu");
      const buttons = Array.from(menu.querySelectorAll("button[data-panel]"));

      function activate(panelId) {
        buttons.forEach(b => b.classList.toggle("active", b.dataset.panel === panelId));
        document.querySelectorAll(".panel").forEach(p => p.classList.toggle("active", p.id === panelId));

        const btn = buttons.find(b => b.dataset.panel === panelId);
        const titleText = btn ? btn.textContent.trim() : "";

        const panelEl = document.getElementById(panelId);
        const barEl = panelEl ? panelEl.querySelector("[data-bar]") : null;
        if (barEl && titleText) barEl.textContent = titleText;

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      buttons.forEach(btn => btn.addEventListener("click", () => activate(btn.dataset.panel)));

      const defaultPanel = (buttons.find(b => b.classList.contains("active")) || buttons[0])?.dataset.panel;
      if (defaultPanel) activate(defaultPanel);

      const p3_receive = document.getElementById("p3_receive_date");
      if (p3_receive) p3_receive.value = todayISO();
    });

    // ====== p1 / p2 / p5ÔºàÊü•Ë©¢Ôºâ=====
    async function realSearch(panelId){
      try {
        setMsg(panelId, "", "Êü•Ë©¢‰∏≠‚Ä¶");

        if (panelId === "p1"){
          const code = document.getElementById("p1_code").value.trim();
          const model = document.getElementById("p1_model").value.trim();
          const url = API_BASE + "?" + qs({ action:"product_lookup", code, model });
          const res = await jsonp(url);

          if (!res.ok) throw new Error(res.msg || "API error");
          if (!res.product) { setMsg("p1", "error", res.msg || "Êü•ÁÑ°Ë≥áÊñô"); return; }

          const kv = document.getElementById("p1_kv").children;
          kv[1].textContent = res.product.product_code || "‚Äî";
          kv[3].textContent = res.product.model_no || "‚Äî";
          kv[5].textContent = res.product.vendor_code || "‚Äî";
          kv[7].textContent = res.product.name_zh || "‚Äî";
          kv[9].textContent = res.product.note || "‚Äî";

          const tbody = document.querySelector("#p1_tbl tbody");
          const items = Array.isArray(res.items) ? res.items : [];
          tbody.innerHTML = items.length ? items.map(it => `
            <tr>
              <td>${esc(it.item)}</td>
              <td>${esc(it.part_code)}</td>
              <td>${esc(it.part_model)}</td>
              <td>${esc(it.description)}</td>
              <td>${esc(it.note)}</td>
              <td>${esc(it.stock_qty)}</td>
            </tr>
          `).join("") : `<tr><td colspan="6" style="color:#5b6b85;">Êü•ÁÑ° BOM/ÂÇôÂìÅË≥áÊñô</td></tr>`;

          setMsg("p1", "ok", "Êü•Ë©¢ÂÆåÊàê");
          return;
        }

        if (panelId === "p2"){
          const sn = document.getElementById("p2_sn").value.trim();
          const mac = document.getElementById("p2_mac").value.trim();
          const url = API_BASE + "?" + qs({ action:"serial_lookup", sn, mac });
          const res = await jsonp(url);

          if (!res.ok) throw new Error(res.msg || "API error");
          if (!res.data){ setMsg("p2", "error", res.msg || "Êü•ÁÑ°Ë≥áÊñô"); return; }

          const kv = document.getElementById("p2_kv").children;
          kv[1].textContent  = res.data.serial_no || "‚Äî";
          kv[3].textContent  = res.data.model_no || "‚Äî";
          kv[5].textContent  = res.data.ship_date || "‚Äî";
          kv[7].textContent  = res.data.customer_name || "‚Äî";
          kv[9].textContent  = res.data.ship_doc_no || "‚Äî";
          kv[11].textContent = res.data.mac_addr || "‚Äî";
          kv[13].textContent = res.data.p2p_id || "‚Äî";

          setMsg("p2", "ok", "Êü•Ë©¢ÂÆåÊàê");
          return;
        }

        if (panelId === "p5"){
          const q = document.getElementById("p5_q").value.trim();
          const url = API_BASE + "?" + qs({ action:"camera_spare_lookup", q });
          const res = await jsonp(url);

          if (!res.ok) throw new Error(res.msg || "API error");

          const rows = Array.isArray(res.rows) ? res.rows : [];
          const tbody = document.querySelector("#p5_tbl tbody");
          tbody.innerHTML = rows.length
            ? rows.map(r => `
                <tr>
                  <td>${esc(r.camera)}</td>
                  <td>${esc(r.part_code)}</td>
                  <td>${esc(r.part_model)}</td>
                  <td>${esc(r.description)}</td>
                  <td>${esc(r.note)}</td>
                  <td>${esc(r.stock_qty)}</td>
                </tr>
              `).join("")
            : `<tr><td colspan="6" style="color:#5b6b85;">${esc(res.msg || "Êü•ÁÑ°Ë≥áÊñô")}</td></tr>`;

          setMsg("p5", rows.length ? "ok" : "error", rows.length ? "Êü•Ë©¢ÂÆåÊàê" : (res.msg || "Êü•ÁÑ°Ë≥áÊñô"));
          return;
        }

        setMsg(panelId, "error", "Êú™Áü•ÁöÑ panelId");

      } catch (err) {
        setMsg(panelId, "error", "Êü•Ë©¢Â§±ÊïóÔºö" + (err && err.message ? err.message : String(err)));
      }
    }

    // ====== p3ÔºöÁ∂≠‰øÆÂõûÂ†±ÔºàÂê´‰∏äÂÇ≥Ôºâ=====
    async function p3LookupModel(){
      const code = document.getElementById("p3_product_code").value.trim();
      if (!code) return;

      try{
        setMsg("p3","", "Êü•Ë©¢ÂûãËôü‰∏≠‚Ä¶");
        const url = API_BASE + "?" + qs({ action:"product_lookup", code });
        const res = await jsonp(url);
        if (!res.ok) throw new Error(res.msg || "API error");

        const model = (res.product && res.product.model_no) ? res.product.model_no : "";
        document.getElementById("p3_model_no").value = model || "";
        setMsg("p3","ok", model ? "Â∑≤Â∏∂Âá∫ÂûãËôü" : "Êü•Âà∞ÊñôËôüÔºå‰ΩÜÂûãËôüÊ¨Ñ‰ΩçÁÇ∫Á©∫ÔºàË´ãÁ¢∫Ë™ç ProductMasterÔºâ");
      }catch(err){
        setMsg("p3","error","ÂûãËôüÂ∏∂Âá∫Â§±ÊïóÔºö" + (err.message || err));
      }
    }

    function p3Clear(){
      document.getElementById("p3_item_type").value = "NVR";
      document.getElementById("p3_product_code").value = "";
      document.getElementById("p3_model_no").value = "";
      document.getElementById("p3_serial_no").value = "";
      document.getElementById("p3_repair_no").value = "";
      document.getElementById("p3_customer").value = "";
      document.getElementById("p3_issue").value = "";
      document.getElementById("p3_action").value = "";
      document.getElementById("p3_region").value = "Âåó";
      document.getElementById("p3_engineer").value = "Ê∞∏ÂØå";
      document.getElementById("p3_receive_date").value = todayISO();
      document.getElementById("p3_ship_date").value = "";
      document.getElementById("p3_status").value = "OPEN";
      document.getElementById("p3_files").value = "";
      document.getElementById("p3_preview").innerHTML = "";
      setMsg("p3","", "Â∑≤Ê∏ÖÁ©∫Ë°®ÂñÆ");
    }

    async function p3PreviewFiles(){
      const el = document.getElementById("p3_files");
      const files = Array.from(el.files || []);
      const box = document.getElementById("p3_preview");
      box.innerHTML = "";

      if (!files.length) return;

      const images = files.filter(f => f.type.startsWith("image/"));
      const videos = files.filter(f => f.type.startsWith("video/"));

      if (images.length > MAX_PHOTOS){
        setMsg("p3","error", `ÁÖßÁâáÊúÄÂ§ö ${MAX_PHOTOS} ÂºµÔºåË´ãÈáçÊñ∞ÈÅ∏Êìá`);
        el.value = "";
        return;
      }
      if (videos.length > 1){
        setMsg("p3","error", "ÂΩ±ÁâáÊúÄÂ§ö 1 ÊÆµÔºåË´ãÈáçÊñ∞ÈÅ∏Êìá");
        el.value = "";
        return;
      }

      const tooBig = files.find(f => (f.size / 1024 / 1024) > MAX_FILE_MB);
      if (tooBig){
        setMsg("p3","error", `ÂñÆ‰∏ÄÊ™îÊ°à‰∏çÂèØË∂ÖÈÅé ${MAX_FILE_MB}MBÔºö${tooBig.name}`);
        el.value = "";
        return;
      }

      if (videos.length === 1){
        setMsg("p3","", "Ê™¢Êü•ÂΩ±ÁâáÈï∑Â∫¶‰∏≠‚Ä¶");
        const dur = await getVideoDurationSeconds(videos[0]);
        if (dur && dur > MAX_VIDEO_SECONDS){
          setMsg("p3","error", `ÂΩ±ÁâáÈúÄÂ∞èÊñº ${MAX_VIDEO_SECONDS} ÁßíÔºàÁõÆÂâçÁ¥Ñ ${Math.ceil(dur)} ÁßíÔºâ`);
          el.value = "";
          return;
        }
      }

      images.forEach(f=>{
        const url = URL.createObjectURL(f);
        const div = document.createElement("div");
        div.className = "thumb";
        div.innerHTML = `<img src="${url}" alt="">`;
        box.appendChild(div);
      });

      if (videos.length === 1){
        const v = document.createElement("div");
        v.className = "pill";
        v.textContent = `Â∑≤ÈÅ∏ÂΩ±ÁâáÔºö${videos[0].name}`;
        box.appendChild(v);
      }

      setMsg("p3","ok", `Â∑≤ÈÅ∏ÊìáÔºöÁÖßÁâá ${images.length} Âºµ${videos.length? "„ÄÅÂΩ±Áâá 1 ÊÆµ":""}`);
    }

    async function p3Submit(){
      try{
        setMsg("p3","", "ÈÄÅÂá∫‰∏≠ÔºàÂê´‰∏äÂÇ≥Ê™îÊ°àÔºâ‚Ä¶");

        const payload = {
          action: "repair_add",
          client_token: uuid(),

          item_type: document.getElementById("p3_item_type").value,
          product_code: document.getElementById("p3_product_code").value.trim(),
          model_no: document.getElementById("p3_model_no").value.trim(),
          serial_no: document.getElementById("p3_serial_no").value.trim(),
          repair_no: document.getElementById("p3_repair_no").value.trim(),
          customer: document.getElementById("p3_customer").value.trim(),
          issue_desc: document.getElementById("p3_issue").value.trim(),
          repair_action: document.getElementById("p3_action").value.trim(),
          receive_date: document.getElementById("p3_receive_date").value,
          ship_back_date: document.getElementById("p3_ship_date").value,
          region: document.getElementById("p3_region").value,
          engineer: document.getElementById("p3_engineer").value,
          status: document.getElementById("p3_status").value,

          // ‰Ω†‰πüÂèØ‰ª•ÊîπÊàêÁôªÂÖ•Â∏≥ËôüÔºåÊàëÂÖàÂõ∫ÂÆöÁïôÁ©∫ËÆì‰Ω†‰πãÂæåÊé•
          created_by: ""
        };

        if (!payload.product_code) { setMsg("p3","error","Ë´ãËº∏ÂÖ•ÊñôËôüÔºàÂøÖÂ°´Ôºâ"); return; }
        if (!payload.serial_no) { setMsg("p3","error","Ë´ãËº∏ÂÖ•Â∫èËôüÔºàÂøÖÂ°´Ôºâ"); return; }
        if (!payload.issue_desc) { setMsg("p3","error","Ë´ãËº∏ÂÖ•Á∂≠‰øÆÂéüÂõ†Ë™™ÊòéÔºàÂøÖÂ°´Ôºâ"); return; }

        const files = Array.from(document.getElementById("p3_files").files || []);
        const images = files.filter(f => f.type.startsWith("image/"));
        const videos = files.filter(f => f.type.startsWith("video/"));
        if (images.length > MAX_PHOTOS) { setMsg("p3","error", `ÁÖßÁâáÊúÄÂ§ö ${MAX_PHOTOS} Âºµ`); return; }
        if (videos.length > 1) { setMsg("p3","error", "ÂΩ±ÁâáÊúÄÂ§ö 1 ÊÆµ"); return; }

        const fileObjs = [];
        for (const f of files){
          const b64 = await fileToBase64(f);
          fileObjs.push({
            name: f.name,
            mime: f.type || "application/octet-stream",
            size: f.size,
            base64: b64
          });
        }
        payload.files = fileObjs;

        const resp = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const json = await resp.json();
        if (json && json.ok){
          setMsg("p3","ok", `ÈÄÅÂá∫ÊàêÂäüÔºÅÁ∂≠‰øÆÂñÆÔºö${json.repair_id || "‚Äî"}`);

          document.getElementById("p4_sn").value = payload.serial_no;
          await p4SearchBySN();
          return;
        }
        setMsg("p3","error", "ÈÄÅÂá∫Â§±ÊïóÔºö" + (json?.msg || "Êú™Áü•ÈåØË™§"));

      }catch(err){
        setMsg("p3","error","ÈÄÅÂá∫Â§±ÊïóÔºö" + (err && err.message ? err.message : String(err)));
      }
    }

    // ====== p4ÔºöÁ∂≠‰øÆÊü•Ë©¢ ======
    function driveViewUrl(fileId){
      return `https://drive.google.com/uc?export=view&id=${encodeURIComponent(fileId)}`;
    }
    function driveOpenUrl(fileId){
      return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/view`;
    }

    async function p4SearchByRegion(){
      const region = document.getElementById("p4_region").value;
      setMsg("p4","", "Êü•Ë©¢‰∏≠‚Ä¶");
      const url = API_BASE + "?" + qs({ action:"repair_query", region });
      const res = await jsonp(url);
      if (!res.ok) { setMsg("p4","error", res.msg || "Êü•Ë©¢Â§±Êïó"); return false; }
      renderRepairRows_(res.rows || []);
      setMsg("p4","ok", `Êü•Ë©¢ÂÆåÊàêÔºö${(res.rows||[]).length} Á≠Ü`);
      return true;
    }

    async function p4SearchByModel(){
      const model_no = document.getElementById("p4_model").value.trim();
      if (!model_no){ setMsg("p4","error","Ë´ãËº∏ÂÖ•ÂûãËôü"); return false; }
      setMsg("p4","", "Êü•Ë©¢‰∏≠‚Ä¶");
      const url = API_BASE + "?" + qs({ action:"repair_query", model_no });
      const res = await jsonp(url);
      if (!res.ok) { setMsg("p4","error", res.msg || "Êü•Ë©¢Â§±Êïó"); return false; }
      renderRepairRows_(res.rows || []);
      setMsg("p4","ok", `Êü•Ë©¢ÂÆåÊàêÔºö${(res.rows||[]).length} Á≠Ü`);
      return true;
    }

    async function p4SearchBySN(){
      const serial_no = document.getElementById("p4_sn").value.trim();
      if (!serial_no){ setMsg("p4","error","Ë´ãËº∏ÂÖ•Â∫èËôü"); return false; }
      setMsg("p4","", "Êü•Ë©¢‰∏≠‚Ä¶");
      const url = API_BASE + "?" + qs({ action:"repair_query", serial_no });
      const res = await jsonp(url);
      if (!res.ok) { setMsg("p4","error", res.msg || "Êü•Ë©¢Â§±Êïó"); return false; }
      renderRepairRows_(res.rows || []);
      setMsg("p4","ok", `Êü•Ë©¢ÂÆåÊàêÔºö${(res.rows||[]).length} Á≠Ü`);
      return (res.rows||[]).length > 0;
    }

    function renderRepairRows_(rows){
      const tbody = document.querySelector("#p4_tbl tbody");
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="9" style="color:#5b6b85;">Êü•ÁÑ°Ë≥áÊñô</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r=>{
        const files = Array.isArray(r.files) ? r.files : [];
        const imgs = files.filter(x => (x.mime||"").startsWith("image/"));
        const vids = files.filter(x => (x.mime||"").startsWith("video/"));

        const thumbs = imgs.slice(0,5).map(f=>{
          const u = driveViewUrl(f.id);
          const a = driveOpenUrl(f.id);
          return `<a class="thumb" href="${a}" target="_blank" title="${esc(f.name||"")}"><img src="${u}" alt=""></a>`;
        }).join("");

        const videoLink = vids.length
          ? `<div style="margin-top:8px;"><a href="${driveOpenUrl(vids[0].id)}" target="_blank" class="pill">üé¨ ÂΩ±ÁâáÔºö${esc(vids[0].name||"ÈñãÂïü")}</a></div>`
          : "";

        return `
          <tr>
            <td style="white-space:nowrap;font-weight:900;">${esc(r.repair_id||"‚Äî")}</td>
            <td>${esc(r.receive_date||"‚Äî")}</td>
            <td>${esc(r.region||"‚Äî")}</td>
            <td>${esc(r.item_type||"‚Äî")}</td>
            <td>${esc(r.product_code||"‚Äî")}<div style="color:#5b6b85;font-size:12px;margin-top:4px;">${esc(r.model_no||"")}</div></td>
            <td>${esc(r.serial_no||"‚Äî")}</td>
            <td>${esc(r.customer||"‚Äî")}<div style="color:#5b6b85;font-size:12px;margin-top:4px;">Á∂≠‰øÆÂñÆÔºö${esc(r.repair_no||"")}</div></td>
            <td>${esc(r.engineer||"‚Äî")}</td>
            <td>
              <div class="pill">${esc(r.status||"‚Äî")}</div>
              <div class="thumbs" style="margin-top:10px;">${thumbs || ""}</div>
              ${videoLink}
            </td>
          </tr>
        `;
      }).join("");
    }
  </script>
</head>

<body>
  <header class="topbar">
    <div class="wrap">
      <div><div class="brand-title">TECOMÔΩúÂ§ñË≥º
